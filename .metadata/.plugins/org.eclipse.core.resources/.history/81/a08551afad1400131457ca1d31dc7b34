package test;

import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

/**
 * Servlet implementation class Login
 */
@WebServlet("/Login")
public class Login extends HttpServlet {
	private static final long serialVersionUID = 1L;
	private static final String mainURL = "http://localhost:8080/Shop/";
	private static final String shopURL = "http://localhost:8080/Shop/List";
	private static final String dataBaseURL = "jdbc:postgresql://127.0.0.1:5432/postgres";
	private static final String dataBaseLogin = "postgres";
	private static final String dataBasePassword = "postgres";
	private static final String driverURL = "org.postgresql.Driver";
	

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse
	 *      response)
	 */
	protected void doGet(HttpServletRequest request,
			HttpServletResponse response) throws ServletException, IOException {
		
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse
	 *      response)
	 */
	public static class DatabaseManager{
		
		public static boolean checkLogin(String login,String password){
			ResultSet rs = executeQuery(selectQuery(login,password));
			try {
				if(!rs.next()){
					return false;
				}
				return true;
			} catch (SQLException e) {
				e.printStackTrace();
				return false;
			}
		}
		
		public static boolean register(String login,String password){
			executeQuery(insertQuery(login,password));
			return true;
		}
		
		public ResultSet listProducts(){
			return executeQuery(productsQuery());
		}
		
		public static ResultSet executeQuery(String query){
			Connection dataBase = null;
			try {
				Class.forName(driverURL).newInstance();
			} catch (InstantiationException | IllegalAccessException
					| ClassNotFoundException e) {
				e.printStackTrace();
			}
			try {
				dataBase = DriverManager.getConnection(dataBaseURL,dataBaseLogin,dataBasePassword);
				Statement stat = dataBase.createStatement();
				return stat.executeQuery(query);
			}
			catch (SQLException e) {System.out.println("UWAGA");e.printStackTrace();
				return null;
			}
		}
		public static String productsQuery(){
			return "SELECT * FROM products;";
		}
		private static String insertQuery(String login, String password){
			return "INSERT INTO users(login,password) VALUES ('"+login+"','"+password+"');";
		}
		private static String selectQuery(String login,String password){
			return "SELECT * FROM users WHERE login ='"+login+"' AND password = '"+password+"';";
		}
	}
	
	
	protected void doPost(HttpServletRequest request,
			HttpServletResponse response) throws ServletException, IOException {
		String pass = request.getParameter("password");
		String log = request.getParameter("login");
		String action = request.getParameter("action");
		HttpSession session = request.getSession();
		boolean suceeded;
		
		if(action.equals("login")){
			suceeded = login(log,pass);
			if(suceeded){
				session.setAttribute("login", log);
				session.setAttribute("password", pass);
				session.setAttribute("logged",true);
				response.sendRedirect(shopURL);
			}
			else{
				logout(session,response);
			}
			
		}
		else if(action.equals("register")){
			
			suceeded = register(log,pass);
			response.sendRedirect(mainURL);
		}
		else if(action.equals("logout")){
			logout(session,response);
		}
		
	}

	public static void checkLogin(HttpServletResponse response,HttpSession session, String login,String password){
		if(!Login.login(login, password)){
			Login.logout(session, response);
		}
	}
	
	private boolean register(String log, String pass) {
		Connection dataBase = null;
		try {
			Class.forName(driverURL).newInstance();
		} catch (InstantiationException | IllegalAccessException
				| ClassNotFoundException e) {
			e.printStackTrace();
		}
		try {
			dataBase = DriverManager.getConnection(dataBaseURL, dataBaseLogin, dataBasePassword);
			Statement stat = dataBase.createStatement();
			stat.executeQuery(insertQuery(log,pass));
			return true;
		} catch (SQLException e) {
			return false;
		}
	}

	public static boolean login(String log, String pass) {
		return DatabaseManager.checkLogin(log, pass);
	}
	public static void logout(HttpSession session,HttpServletResponse response){
		session.invalidate();
		try {
			response.sendRedirect(mainURL);
		} catch (IOException e) {
			e.printStackTrace();
		}
	}
	private String insertQuery(String login, String password){
		return "INSERT INTO users(login,password) VALUES ('"+login+"','"+password+"');";
	}
	private static String selectQuery(String login,String password){
		return "SELECT * FROM users WHERE login ='"+login+"' AND password = '"+password+"';";
	}

}
